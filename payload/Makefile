C_FILES  := $(foreach dir, ., $(wildcard $(dir)/*.c))
S_FILES  := $(foreach dir, ., $(wildcard $(dir)/*.S))

OBJS  := $(C_FILES:.c=.o)  $(S_FILES:.S=.o)

PREFIX  = $(DEVKITARM)/bin/arm-none-eabi
CC      = $(PREFIX)-gcc
LD      = $(PREFIX)-ld
STRIP   = $(PREFIX)-strip
OBJCOPY = $(PREFIX)-objcopy

ASFLAGS   = -marm -fomit-frame-pointer -mbig-endian -fshort-wchar -mcpu=arm926ej-s -march=armv5te -fno-zero-initialized-in-bss
CFLAGS   = -s -Os -Wall $(ASFLAGS)
LDFLAGS = -n -nostartfiles -EB -L"$(DEVKITARM)/arm-none-eabi/lib"

all: ../arm/payload.h

../arm/payload.h: payload.bin
	xxd -i $^ $@ 

payload.bin: payload.elf
	$(OBJCOPY) -S -O binary $^ $@

payload.elf: $(OBJS)
	$(LD) $(LDFLAGS) -T link.ld $^ -o $@
	$(STRIP) $@

%.o: %.c
	$(CC) $(CFLAGS) -c $^ -o $@
%.o: %.S
	$(CC) $(ASFLAGS) -c $^ -o $@

clean:
	@rm -rf $(OBJS) payload.elf payload.bin
	@echo "Cleaned!"
