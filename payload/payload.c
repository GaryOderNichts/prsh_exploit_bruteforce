#include "types.h"
#include "latte.h"
#include "utils.h"
#include "gpio.h"

void _main(void)
{
	u32 *prsh;
	int i;

	/*
	 * Inform the external device that the exploit succeded and
	 * our custom payload was succefully executed by generating
	 * 10 output changes on the sensorbar GPIO at a distance of
	 * around 1 second.
	 */
	clear32(LT_GPIO_OWNER, GP_SENSORBAR);
	set32(LT_GPIO_ENABLE, GP_SENSORBAR);
	set32(LT_GPIO_DIR, GP_SENSORBAR);
	for (i = 0; i < 15; i++) {
		write32(LT_GPIO_OUT, read32(LT_GPIO_OUT) ^ GP_SENSORBAR);
		udelay(1000000);
	}

	/* fix the PRSH */
	prsh = (u32 *)0x10005A54;
	prsh[0x47] = 0x10008000;
	prsh[0x00] = 0;
	for (i = 1; i < 0x52; i++) {
		prsh[0x00] ^= prsh[i];
	}

	while(1);
}
